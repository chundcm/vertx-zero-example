# 思无邪：入参

>  百舌搬春春已透，长驿短亭芳草昼，家山肠断欲归人，风宿留、船津候。——吴潜《天仙子》

* 项目地址：<https://github.com/silentbalanceyh/vertx-zero-example/>（子项目：**up-apollo**）

## 「壹」RESTful参数

　　前边章节介绍了，如何使用HTTP标准的方法完成RESTful开发，在使用不同的方式时，它的传参方式会有所区别，Zero框架在原始态的即使之上，引入了更为**实用**的状态，解决大部分开发者在发送HTTP请求时遇到的高频问题。

　　通常的RESTful的HTTP请求有一个限制：GET和DELETE不允许带`Body`，这是Http协议中的一种约定，像著名的`Apache Http Component`开源项目中，如果要让GET和DELETE携带`Body`请求，就需要自己开发自定义的`HttpRequest`，那么究竟是遵循协议？还是遵循现实？从众多商业项目中考量，最终Zero对实战进行妥协，在GET和DELETE中引入了`Body`，目的是为了解决某些现存的高频问题。

　　根据参数的某些使用场景的特性，我把它分成了以下几类。

### 1.1. 路径参数

　　路径参数是RESTful中的常用参数，参考下边代码：

```java
package cn.vertxup.micro.params;

import io.vertx.up.annotations.EndPoint;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;

@EndPoint
public class PathAgent {
    /*
     * 响应信息
     * {
     *      "data": "Hi <name>"
     * }
     */
    @GET
    @Path("/hi/param/name/:name")
    public String sayName(@PathParam("name") final String name) {
        return "Hi " + name;
    }

    /*
     * 响应信息
     * {
     *      "data": "Hi , the Email is <email>"
     * }
     */
    @GET
    @Path("/hi/param/email/{email}")
    public String sayEmail(@PathParam("email") final String email) {
        return "Hi , the Email is " + email;
    }
}
```

　　在Zero中运行上述代码并且发送请求，就会得到注释中的响应信息。请求格式如下：

```shell
## 两个测试请求地址如
/hi/param/name/Lang
/hi/param/email/lang.yu@hpe.com
```

　　注意上述代码中的参数格式：

1. 第一种格式`:name`是Vertx框架中支持的原生格式，整个Path部分会遵循Vertx中定义的规范，包括正则表达式以及其他相关内容。
2. 第二种格式`{email}`是很多开发者熟悉的Spring框架和JSR311中的常用格式，Vertx是不支持这种格式的，但Zero同样支持这种格式，以保证开发人员的使用。

　　统一路径格式的主要目的是让任何人都可以上手，虽然这部分具有一定的二义性，但使用Zero的开发人员背景不同，可能习惯会有所差异，经常用`vertx-web`开发的人比较钟意第一种格式，而如果曾经是Spring的开发人员，则倾向于第二种格式。

　　Zero为了解决开发人员的某些错误写法，提供了路径的兼容解析，参考下边代码：

```java
package cn.vertxup.micro.params;

import io.vertx.up.annotations.EndPoint;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;

@EndPoint
public class PathWrong {
    /*
     *  {
     *      "data": "Hi , Your age is <age>"
     *  }
     */
    @GET
    @Path("hi//param/age/:age/")
    public String sayAge(@PathParam("age") final Integer age) {
        return "Hi , Your age is " + age;
    }

    /*
     *  {
     *      "data": "Hi, Your current is <currency>"
     *  }
     */
    @GET
    @Path("hi//param///currency///:currency")
    public String sayCurrent(@PathParam("currency") final double currency) {
        return "Hi, Your current is " + currency;
    }
}
```

　　上述两种路径通常会理解成开发人员的错误设计或错误使用，但从最终结果可以知道开发人员原本用意，Zero会有专用日志记录这个警告，但以正确结果发布RESTful接口，在项目进度比较紧张的时候可以不用考虑这种**失误**，警告部分日志如下：

```shell
## 请求地址
/hi/param/age/32
/hi/param/currency/14.77

## 输出信息
[ Path ] The original uri is `hi//param/age/:age/`, \
        recommend/detected uri is `/hi/param/age/:age`.
```

### 1.2. 查询参数

　　查询参数通常用于传统的GET页面请求，一般情况下不带Body直接发送，通常用于获取资源信息，参考下边代码：

```java
package cn.vertxup.micro.params;

import io.vertx.core.json.JsonObject;
import io.vertx.up.annotations.EndPoint;

import javax.ws.rs.BodyParam;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.QueryParam;

@EndPoint
public class QueryAgent {
    /*
     * {
     *      "data": "Hi Lang"
     * }
     */
    @GET
    @Path("/hi/param/query-string")
    public String sayQuery(@QueryParam("name") final String name) {
        return "Hi " + name;
    }

    /*
     * {
     *      "data": {
     *          "name": "Lang",
     *          "data": {
     *              "email": "lang.yu@hpe.com",
     *              "age": 12
     *          }
     *      }
     *  }
     */
    @GET
    @Path("/hi/param/query-body")
    public JsonObject sayQBody(@QueryParam("name") final String name,
                               @BodyParam final JsonObject data) {
        return new JsonObject().put("name", name).put("data", data);
    }
}
```

　　发送下边的请求就可以得到注释中的响应信息：

```shell
# 请求地址
/hi/param/query-string?name=Lang
/hi/param/query-body?name=Lang
```

　　注，在第二个请求中包含了请求体的内容：

```json
{
	"email":"lang.yu@hpe.com",
	"age":12
}
```

　　从示例代码中可以看到，对应的请求参数`name`直接被读取到了。

### 1.3. 请求体

　　第三种常用的参数是请求体参数，一般用于`POST`和`PUT`中，当然在zero框架中，`GET`和`DELETE`请求同样可以携带Body请求体参数，上边第二个例子演示的就是在GET请求中携带Body请求体参数。Zero中的请求体参数主要有两种，通过扩展JSR311来注解：

* 字符流请求体注解：`javax.ws.rs.BodyParam`。
* 二进制（字节流）数据请求体注解：`javax.ws.rs.StreamParam`。

　　扩展JSR311是Zero为了渗透业务量身定制的两个注解，参考下边代码：

```java

```

　　